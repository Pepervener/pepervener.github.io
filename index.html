<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>La Bulle des OliGoFriends üÉè</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0b08;
    --surface: #1a1610;
    --surface2: #211e18;
    --gold: #c9972c;
    --gold-light: #e8b84b;
    --red: #c0392b;
    --red-light: #e74c3c;
    --green: #27ae60;
    --green-light: #2ecc71;
    --text: #f0e8d8;
    --text-muted: #8a7d65;
    --border: #3a3020;
    --card-bg: #faf6ee;
    --card-text-dark: #1a1a1a;
    --card-shadow: 0 8px 32px rgba(0,0,0,0.6);
    --transition-theme: background 0.35s, color 0.35s, border-color 0.35s, box-shadow 0.35s;
  }

  /* ===== LIGHT MODE ===== */
  body.light {
    --bg: #f5f0e8;
    --surface: #ede7d9;
    --surface2: #e2dace;
    --gold: #a0721a;
    --gold-light: #b8860b;
    --red: #c0392b;
    --red-light: #e74c3c;
    --green: #1e8449;
    --green-light: #27ae60;
    --text: #2c2416;
    --text-muted: #7a6a52;
    --border: #c8b898;
    --card-bg: #ffffff;
    --card-shadow: 0 4px 16px rgba(0,0,0,0.12);
  }

  body.light::before {
    background:
      radial-gradient(ellipse 60% 40% at 50% 0%, rgba(160,114,26,0.07) 0%, transparent 70%),
      repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.01) 2px, rgba(0,0,0,0.01) 4px);
  }

  /* Theme toggle button */
  .theme-toggle {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    width: 40px;
    height: 24px;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 2px;
    transition: var(--transition-theme);
    flex-shrink: 0;
  }

  .theme-toggle-knob {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--gold);
    transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), background 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    line-height: 1;
  }

  body.light .theme-toggle-knob {
    transform: translateX(16px);
  }

  /* header needs relative for the toggle */
  header { position: relative; }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.35s, color 0.35s;
  }

  /* ===== TIMER ===== */
  .timer-section {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    transition: var(--transition-theme);
  }

  .timer-label {
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .timer-display {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 900;
    line-height: 1;
    min-width: 2ch;
    text-align: center;
    transition: color 0.3s;
  }

  .timer-display.urgent { color: var(--red-light); animation: pulse-red 0.5s ease-in-out infinite alternate; }
  .timer-display.warn   { color: var(--gold-light); }
  .timer-display.ok     { color: var(--green-light); }

  @keyframes pulse-red {
    from { transform: scale(1); }
    to   { transform: scale(1.12); }
  }

  .timer-ring {
    position: relative;
    width: 48px;
    height: 48px;
    flex-shrink: 0;
  }

  .timer-ring svg {
    transform: rotate(-90deg);
  }

  .timer-ring-bg { fill: none; stroke: var(--border); stroke-width: 4; }
  .timer-ring-fill {
    fill: none;
    stroke-width: 4;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.9s linear, stroke 0.3s;
  }

  .timer-controls {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .timer-toggle-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .timer-duration-row {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.65rem;
    color: var(--text-muted);
  }

  .timer-duration-row input[type=range] {
    width: 70px;
    accent-color: var(--gold);
    cursor: pointer;
  }

  /* pill toggle for timer enable */
  .pill-toggle {
    position: relative;
    width: 34px;
    height: 20px;
    border-radius: 10px;
    background: var(--border);
    cursor: pointer;
    border: none;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .pill-toggle.on { background: var(--green); }
  .pill-toggle::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: white;
    transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1);
  }
  .pill-toggle.on::after { transform: translateX(14px); }

  .penalty-badge {
    font-size: 0.6rem;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(192,57,43,0.15);
    color: var(--red-light);
    border: 1px solid rgba(192,57,43,0.3);
    white-space: nowrap;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 50% 0%, rgba(201,151,44,0.08) 0%, transparent 70%),
      repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.01) 2px, rgba(255,255,255,0.01) 4px);
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 240px 1fr 280px;
    grid-template-rows: auto 1fr;
    height: 100vh;
    overflow: hidden;
    gap: 0;
  }

  /* HEADER */
  header {
    grid-column: 1 / -1;
    text-align: center;
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(201,151,44,0.06) 0%, transparent 100%);
  }

  header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 900;
    letter-spacing: 0.02em;
    color: var(--gold-light);
    text-shadow: 0 0 40px rgba(201,151,44,0.4);
  }

  header p {
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* PANELS */
  .panel-left {
    border-right: 1px solid var(--border);
    padding: 20px 16px;
    background: var(--surface);
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
    transition: var(--transition-theme);
  }

  .panel-center {
    padding: 16px 20px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    overflow: hidden;
    min-height: 0;
    transition: var(--transition-theme);
  }

  .panel-right {
    border-left: 1px solid var(--border);
    padding: 20px 16px;
    background: var(--surface);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    transition: var(--transition-theme);
  }

  /* SECTION TITLES */
  .section-title {
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gold);
    border-bottom: 1px solid var(--border);
    padding-bottom: 6px;
    margin-bottom: 10px;
  }

  /* PLAYER SETUP */
  .player-input-row {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
  }

  .player-input-row input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.2s;
  }

  .player-input-row input:focus { border-color: var(--gold); }

  .btn-small {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--gold);
    padding: 6px 10px;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .btn-small:hover { border-color: var(--gold); background: rgba(201,151,44,0.1); }

  /* AVATAR */
  .avatar-area {
    text-align: center;
  }

  .avatar-emoji {
    font-size: 4rem;
    display: block;
    transition: all 0.5s;
    filter: drop-shadow(0 0 10px rgba(201,151,44,0.3));
  }

  .avatar-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    color: var(--gold-light);
    margin-top: 6px;
  }

  .avatar-state {
    font-size: 0.65rem;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .sip-bar {
    height: 4px;
    background: var(--surface2);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }

  .sip-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--green), var(--gold), var(--red));
    border-radius: 2px;
    transition: width 0.5s;
  }

  /* PLAYER SELECTOR */
  select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    border-radius: 4px;
    outline: none;
    cursor: pointer;
  }

  /* STATS BOX */
  .stat-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    color: var(--text-muted);
  }
  .stat-row span:last-child { color: var(--text); }

  /* GAME COLUMNS */
  .columns-area {
    width: 100%;
    flex: 1;
    min-height: 0;
    display: flex;
    align-items: stretch;
    justify-content: center;
    gap: 10px;
    padding: 8px;
  }

  .column-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex: 1;
    max-width: 96px;
  }

  /* Scrollable column ‚Äî shows all cards, newest at bottom */
  .column-scroll {
    flex: 1;
    width: 86px;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* push cards to bottom */
    gap: 0;
    /* hide scrollbar visually but keep functional */
    scrollbar-width: none;
  }
  .column-scroll::-webkit-scrollbar { display: none; }

  /* Each card item in the scroll list */
  .card-item {
    width: 86px;
    flex-shrink: 0;
  }

  /* Full card ‚Äî the topmost (latest) card */
  .card {
    width: 86px;
    height: 120px;
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    font-weight: 700;
    border: 1px solid rgba(0,0,0,0.12);
    user-select: none;
    position: relative;
  }

  .card.red-suit { color: #c0392b; }
  .card.black-suit { color: #1a1a1a; }

  .card-value {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    line-height: 1;
  }

  .card-suit { font-size: 1.2rem; line-height: 1; }

  .card-corner {
    position: absolute;
    top: 6px;
    left: 8px;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    font-weight: 500;
    line-height: 1.15;
    text-align: left;
  }

  /* Peek strip ‚Äî under-cards, only top strip visible */
  .card-peek {
    width: 86px;
    height: 22px;
    background: var(--card-bg);
    border-radius: 6px 6px 0 0;
    border: 1px solid rgba(0,0,0,0.12);
    border-bottom: none;
    box-shadow: 0 -1px 4px rgba(0,0,0,0.3);
    user-select: none;
    display: flex;
    align-items: center;
    padding-left: 8px;
    gap: 4px;
    font-size: 0.65rem;
    font-family: 'DM Mono', monospace;
    font-weight: 500;
  }

  .card-peek.red-suit { color: #c0392b; }
  .card-peek.black-suit { color: #1a1a1a; }

  /* Column indicator */
  .col-indicator {
    width: 86px;
    height: 5px;
    border-radius: 3px;
    background: var(--border);
    transition: background 0.3s;
    flex-shrink: 0;
  }
  .column-active .col-indicator { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
  .column-done .col-indicator { background: var(--green); }

  /* BUTTONS */
  .game-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .btn {
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.02em;
  }

  .btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  /* Big action buttons with prob inside */
  .btn-action {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 16px 28px;
    min-width: 160px;
  }

  .btn-action-label {
    font-size: 1.2rem;
    line-height: 1;
  }

  .btn-action-prob {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    font-weight: 400;
    opacity: 0.85;
    letter-spacing: 0.04em;
    line-height: 1;
    min-height: 1em;
  }

  .btn-higher {
    background: linear-gradient(135deg, #27ae60, #1e8449);
    color: white;
    box-shadow: 0 4px 20px rgba(39,174,96,0.35);
  }
  .btn-higher:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 28px rgba(39,174,96,0.5);
  }

  .btn-lower {
    background: linear-gradient(135deg, #c0392b, #922b21);
    color: white;
    box-shadow: 0 4px 20px rgba(192,57,43,0.35);
  }
  .btn-lower:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 28px rgba(192,57,43,0.5);
  }

  .btn-new {
    font-size: 0.9rem;
    padding: 12px 22px;
    background: linear-gradient(135deg, var(--gold), #a07820);
    color: #0d0b08;
    box-shadow: 0 4px 16px rgba(201,151,44,0.3);
  }
  .btn-new:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(201,151,44,0.5);
  }

  .btn-next {
    font-size: 0.9rem;
    padding: 12px 22px;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-next:not(:disabled):hover {
    border-color: var(--gold);
    color: var(--gold);
  }

  /* FEEDBACK MESSAGE */
  .feedback {
    height: 36px;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    text-align: center;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .feedback.correct { color: var(--green-light); }
  .feedback.wrong { color: var(--red-light); }
  .feedback.win { color: var(--gold-light); font-size: 1.2rem; }

  /* COUNTERS */
  .counters {
    display: flex;
    gap: 20px;
  }

  .counter-box {
    text-align: center;
    padding: 10px 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    min-width: 80px;
  }

  .counter-val {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    color: var(--gold-light);
    line-height: 1;
  }

  .counter-lbl {
    font-size: 0.55rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-top: 4px;
  }

  /* HISTORY */
  .history-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
  }

  .history-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px;
    text-align: center;
    font-size: 0.65rem;
    line-height: 1.3;
  }
  .history-card.red-suit { color: #e74c3c; }
  .history-card.black-suit { color: var(--text); }

  /* PLAYERS STATS TABLE */
  .players-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.68rem;
  }

  .players-table th {
    text-align: left;
    color: var(--gold);
    font-weight: 500;
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
  }

  .players-table td {
    padding: 5px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    color: var(--text-muted);
  }

  .players-table tr.active-player td { color: var(--gold-light); }

  /* TOAST */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: var(--surface2);
    border: 1px solid var(--gold);
    color: var(--gold-light);
    padding: 12px 24px;
    border-radius: 8px;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    z-index: 1000;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  @media (max-width: 900px) {
    .app { grid-template-columns: 1fr; }
    .panel-left, .panel-right { border: none; border-top: 1px solid var(--border); }
  }
</style>
</head>
<body>

<div class="app">
  <header>
    <h1>üÉè La Bulle des OliGoFriends</h1>
    <p>Jeu de cartes √† boire ‚Ä¢ Plus Haut / Plus Bas</p>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Mode clair/sombre">
      <div class="theme-toggle-knob" id="themeKnob">üåô</div>
    </button>
  </header>

  <!-- LEFT PANEL -->
  <div class="panel-left">
    <div>
      <div class="section-title">Joueurs</div>
      <div id="playerInputs">
        <div class="player-input-row">
          <input type="text" placeholder="Joueur 1" class="player-name-input" />
          <button class="btn-small" onclick="addPlayer(this)">+</button>
        </div>
      </div>
      <button class="btn-small" style="width:100%; margin-top:6px" onclick="addPlayerRow()">+ Ajouter joueur</button>
    </div>

    <div>
      <div class="section-title">Joueur actif</div>
      <select id="playerSelect" onchange="changeActivePlayer()">
        <option value="">‚Äî Choisir ‚Äî</option>
      </select>
    </div>

    <div class="avatar-area">
      <span class="avatar-emoji" id="avatarEmoji">üôÇ</span>
      <div class="avatar-name" id="avatarName">‚Äî</div>
      <div class="avatar-state" id="avatarState">sobre</div>
      <div class="sip-bar"><div class="sip-bar-fill" id="sipBarFill" style="width:0%"></div></div>
    </div>

    <div>
      <div class="section-title">Stats perso</div>
      <div class="stat-row"><span>Parties jou√©es</span><span id="statGames">0</span></div>
      <div class="stat-row"><span>Gorg√©es totales</span><span id="statSips">0</span></div>
      <div class="stat-row"><span>Gorg√©es session</span><span id="statSipsCurrent">0</span></div>
    </div>

    <div>
      <div class="section-title">Timer</div>
      <div class="timer-section">
        <div class="timer-ring">
          <svg width="48" height="48" viewBox="0 0 48 48">
            <circle class="timer-ring-bg" cx="24" cy="24" r="20"/>
            <circle class="timer-ring-fill" id="timerRingFill" cx="24" cy="24" r="20"
              stroke="var(--green)"
              stroke-dasharray="125.66"
              stroke-dashoffset="0"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span class="timer-display ok" id="timerDisplay">‚Äî</span>
          </div>
        </div>
        <div class="timer-controls">
          <div class="timer-toggle-row">
            <button class="pill-toggle" id="timerPill" onclick="toggleTimer()"></button>
            <span class="timer-label">Activer</span>
          </div>
          <div class="timer-duration-row">
            <span id="timerDurLabel">10s</span>
            <input type="range" id="timerDurSlider" min="5" max="30" step="5" value="10"
              oninput="updateTimerDuration(this.value)" />
          </div>
          <div id="timerPenaltyInfo" class="penalty-badge" style="display:none">+1 gorg√©e si hors d√©lai</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="panel-center">
    <div class="columns-area" id="columnsRow">
      <!-- Generated by JS -->
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="counters">
      <div class="counter-box">
        <div class="counter-val" id="cntPlayed">0</div>
        <div class="counter-lbl">Jou√©es</div>
      </div>
      <div class="counter-box">
        <div class="counter-val" id="cntLeft">52</div>
        <div class="counter-lbl">Restantes</div>
      </div>
      <div class="counter-box">
        <div class="counter-val" id="cntSips" style="color:var(--red-light)">0</div>
        <div class="counter-lbl">Gorg√©es</div>
      </div>
    </div>

    <div class="game-buttons">
      <button class="btn btn-action btn-higher" id="btnHigher" onclick="guess('higher')">
        <span class="btn-action-label">‚ñ≤ Plus Haut</span>
        <span class="btn-action-prob" id="probHigher"></span>
      </button>
      <button class="btn btn-action btn-lower" id="btnLower" onclick="guess('lower')">
        <span class="btn-action-label">‚ñº Plus Bas</span>
        <span class="btn-action-prob" id="probLower"></span>
      </button>
      <button class="btn btn-new" onclick="newGame()">‚Ü∫ Nouvelle Partie</button>
      <button class="btn btn-next" id="btnNext" onclick="nextPlayer()" disabled>Joueur suivant ‚Üí</button>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel-right">
    <div>
      <div class="section-title">Historique des cartes</div>
      <div class="history-grid" id="historyGrid">
        <div style="font-size:0.65rem;color:var(--text-muted);grid-column:1/-1">Aucune carte vue</div>
      </div>
    </div>

    <div>
      <div class="section-title">Classement joueurs</div>
      <table class="players-table" id="playersTable">
        <thead>
          <tr>
            <th>Nom</th>
            <th>üéÆ</th>
            <th>üç∫</th>
          </tr>
        </thead>
        <tbody id="playersTableBody">
          <tr><td colspan="3" style="color:var(--text-muted)">Aucun joueur</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ========== DECK ==========
const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const VALUES = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
const VALUE_ORDER = {2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,'J':11,'Q':12,'K':13,'A':14};

function createDeck() {
  const d = [];
  for (const s of SUITS) for (const v of VALUES) d.push({suit:s, value:v});
  return shuffle(d);
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function cardRank(c) { return VALUE_ORDER[c.value]; }
function isRed(c) { return c.suit==='‚ô•'||c.suit==='‚ô¶'; }

// ========== STATE ==========
let players = []; // {name, games, sips}
let activePlayerIdx = -1;
let deck = [];
let columns = []; // each: array of cards (bottom to top)
let currentCol = 0;
let cardsPlayed = 0;
let sessionSips = 0;
let gameWon = false;
let seenCards = [];

// ========== PLAYER MANAGEMENT ==========
function getPlayers() {
  const inputs = document.querySelectorAll('.player-name-input');
  const names = [...inputs].map(i=>i.value.trim()).filter(n=>n);
  return names;
}

function syncPlayers() {
  const names = getPlayers();
  // Merge with existing players
  const newPlayers = [];
  for (const name of names) {
    const existing = players.find(p=>p.name===name);
    newPlayers.push(existing || {name, games:0, sips:0});
  }
  players = newPlayers;

  const sel = document.getElementById('playerSelect');
  const curVal = sel.value;
  sel.innerHTML = '<option value="">‚Äî Choisir ‚Äî</option>';
  for (let i=0; i<players.length; i++) {
    const o = document.createElement('option');
    o.value = i;
    o.textContent = players[i].name;
    sel.appendChild(o);
  }
  if (activePlayerIdx >= 0 && activePlayerIdx < players.length) {
    sel.value = activePlayerIdx;
  }
  updatePlayersTable();
}

function addPlayerRow() {
  const container = document.getElementById('playerInputs');
  if (container.children.length >= 5) { showToast('Max 5 joueurs !'); return; }
  const row = document.createElement('div');
  row.className = 'player-input-row';
  const idx = container.children.length + 1;
  row.innerHTML = `<input type="text" placeholder="Joueur ${idx}" class="player-name-input" oninput="syncPlayers()"/>
    <button class="btn-small" onclick="removePlayerRow(this)">√ó</button>`;
  container.appendChild(row);
}

function removePlayerRow(btn) {
  btn.parentElement.remove();
  syncPlayers();
}

// Auto-sync on input
document.getElementById('playerInputs').addEventListener('input', syncPlayers);

function changeActivePlayer() {
  const sel = document.getElementById('playerSelect');
  activePlayerIdx = parseInt(sel.value);
  if (isNaN(activePlayerIdx)) { activePlayerIdx = -1; return; }
  sessionSips = 0;
  updateAvatar();
  newGame();
}

// ========== AVATAR ==========
const AVATARS = [
  {max:4, emoji:'üôÇ', state:'Sobre'},
  {max:9, emoji:'üòÑ', state:'D√©tendu'},
  {max:15, emoji:'üòÖ', state:'Tipsy'},
  {max:24, emoji:'ü•¥', state:'√âm√©ch√©'},
  {max:999, emoji:'üòµ', state:'Bourr√©'}
];

function updateAvatar() {
  if (activePlayerIdx < 0) return;
  const p = players[activePlayerIdx];
  const sips = p ? p.sips : 0;
  let av = AVATARS[AVATARS.length-1];
  for (const a of AVATARS) { if (sips <= a.max) { av = a; break; } }
  document.getElementById('avatarEmoji').textContent = av.emoji;
  document.getElementById('avatarName').textContent = p ? p.name : '‚Äî';
  document.getElementById('avatarState').textContent = av.state;
  const pct = Math.min(100, (sips / 25) * 100);
  document.getElementById('sipBarFill').style.width = pct + '%';
  document.getElementById('statGames').textContent = p ? p.games : 0;
  document.getElementById('statSips').textContent = p ? p.sips : 0;
  document.getElementById('statSipsCurrent').textContent = sessionSips;
}

// ========== GAME ==========
function newGame() {
  if (activePlayerIdx < 0) { showToast('S√©lectionne un joueur !'); return; }
  stopTimer();
  deck = createDeck();
  columns = [];
  for (let i=0; i<5; i++) {
    columns.push([deck.pop()]);
  }
  currentCol = 0;
  cardsPlayed = 5;
  sessionSips = 0;
  gameWon = false;
  seenCards = [];
  setFeedback('', '');
  document.getElementById('btnNext').disabled = true;
  renderColumns();
  updateCounters();
  updateAvatar();
  updatePlayersTable();
  updateProbabilities();
  resetTimerDisplay();
  startTimer();
}

function guess(dir) {
  if (activePlayerIdx < 0 || gameWon) return;

  stopTimer();

  // Replenish if needed
  if (deck.length === 0) replenishDeck();

  const topCard = columns[currentCol][columns[currentCol].length-1];
  const nextCard = deck.pop();
  seenCards.push(nextCard);
  cardsPlayed++;

  const topRank = cardRank(topCard);
  const nextRank = cardRank(nextCard);

  columns[currentCol].push(nextCard);
  renderColumns();

  if (nextRank === topRank) {
    const sips = currentCol + 1;
    applyFail(sips, nextCard, '√âgalit√© !');
    startTimer();
  } else if ((dir==='higher' && nextRank > topRank) || (dir==='lower' && nextRank < topRank)) {
    setFeedback(`‚úì ${nextCard.value}${nextCard.suit} ‚Äî Bravo !`, 'correct');
    currentCol++;
    if (currentCol >= 5) {
      gameWon = true;
      players[activePlayerIdx].games++;
      setFeedback('üèÜ Bulle compl√©t√©e ! Bien jou√© !', 'win');
      document.getElementById('btnNext').disabled = false;
      resetTimerDisplay();
    } else {
      startTimer();
    }
  } else {
    const sips = currentCol + 1;
    applyFail(sips, nextCard, `Rat√© ‚Äî ${nextCard.value}${nextCard.suit}`);
    startTimer();
  }

  updateCounters();
  updateAvatar();
  updateHistoryPanel();
  updateProbabilities();
}

function applyFail(sips, card, msg) {
  sessionSips += sips;
  if (activePlayerIdx >= 0) players[activePlayerIdx].sips += sips;
  currentCol = 0;
  setFeedback(`üíÄ ${msg} ‚Äî Bois ${sips} gorg√©e${sips>1?'s':''}!`, 'wrong');
  showToast(`üç∫ ${sips} gorg√©e${sips>1?'s':''}!`);
  renderColumns();
  updateProbabilities();
  updatePlayersTable();
}

function replenishDeck() {
  const reclaimed = [];
  for (let i=0; i<columns.length; i++) {
    if (columns[i].length > 1) {
      reclaimed.push(...columns[i].slice(0, -1));
      columns[i] = [columns[i][columns[i].length-1]];
    }
  }
  deck = shuffle(reclaimed);
  seenCards = [];
  showToast('‚ôªÔ∏è Deck rem√©lang√© !');
}

function nextPlayer() {
  if (!gameWon) return;
  if (players.length === 0) return;
  activePlayerIdx = (activePlayerIdx + 1) % players.length;
  document.getElementById('playerSelect').value = activePlayerIdx;
  sessionSips = 0;
  gameWon = false;
  document.getElementById('btnNext').disabled = true;
  updateAvatar();
  newGame();
}

// ========== RENDER ==========
function renderColumns() {
  const row = document.getElementById('columnsRow');
  row.innerHTML = '';

  for (let i = 0; i < 5; i++) {
    const col = columns[i] || [];
    const isActive = i === currentCol && !gameWon;
    const isDone = gameWon ? true : i < currentCol;

    const wrapper = document.createElement('div');
    wrapper.className = 'column-wrapper' + (isActive ? ' column-active' : '') + (isDone ? ' column-done' : '');

    // Scrollable column container
    const scroll = document.createElement('div');
    scroll.className = 'column-scroll';

    const n = col.length;
    col.forEach((card, idx) => {
      const isTop = idx === n - 1;
      const item = document.createElement('div');
      item.className = 'card-item';

      if (isTop) {
        // Full card for the active top card
        item.appendChild(createCardEl(card));
      } else {
        // Peek strip for all under-cards
        const peek = document.createElement('div');
        peek.className = 'card-peek ' + (isRed(card) ? 'red-suit' : 'black-suit');
        peek.innerHTML = `<span>${card.value}</span><span>${card.suit}</span>`;
        item.appendChild(peek);
      }

      scroll.appendChild(item);
    });

    // Scroll to bottom so the top card (last item) is always visible
    // Use setTimeout to ensure DOM is painted first
    setTimeout(() => { scroll.scrollTop = scroll.scrollHeight; }, 0);

    wrapper.appendChild(scroll);

    // Active column indicator strip
    const ind = document.createElement('div');
    ind.className = 'col-indicator';
    wrapper.appendChild(ind);

    row.appendChild(wrapper);
  }
}

function createCardEl(card) {
  const el = document.createElement('div');
  el.className = 'card ' + (isRed(card) ? 'red-suit' : 'black-suit');

  const corner = document.createElement('div');
  corner.className = 'card-corner';
  corner.innerHTML = `${card.value}<br>${card.suit}`;

  const val = document.createElement('div');
  val.className = 'card-value';
  val.textContent = card.value;

  const suit = document.createElement('div');
  suit.className = 'card-suit';
  suit.textContent = card.suit;

  el.appendChild(corner);
  el.appendChild(val);
  el.appendChild(suit);
  return el;
}

// ========== PROBABILITIES ==========
function computeProbabilities() {
  if (columns.length === 0 || currentCol >= columns.length) return null;
  const col = columns[currentCol];
  if (!col || col.length === 0) return null;
  const topCard = col[col.length - 1];
  const topRank = cardRank(topCard);

  // Count higher, lower, equal cards remaining in deck
  let higher = 0, lower = 0, equal = 0;
  for (const c of deck) {
    const r = cardRank(c);
    if (r > topRank) higher++;
    else if (r < topRank) lower++;
    else equal++;
  }
  const total = deck.length;
  if (total === 0) return { higherPct: 0, lowerPct: 0, equalPct: 0 };
  return {
    higherPct: Math.round((higher / total) * 100),
    lowerPct:  Math.round((lower  / total) * 100),
    equalPct:  Math.round((equal  / total) * 100),
    higher, lower, equal, total
  };
}

function updateProbabilities() {
  const pH = document.getElementById('probHigher');
  const pL = document.getElementById('probLower');

  if (gameWon || activePlayerIdx < 0 || columns.length === 0) {
    pH.textContent = '';
    pL.textContent = '';
    return;
  }

  const p = computeProbabilities();
  if (!p || p.total === 0) {
    pH.textContent = ''; pL.textContent = ''; return;
  }

  pH.textContent = `${p.higherPct}% (${p.higher}/${p.total} cartes)`;
  pL.textContent = `${p.lowerPct}% (${p.lower}/${p.total} cartes)`;
}

function updateCounters() {
  document.getElementById('cntPlayed').textContent = cardsPlayed;
  document.getElementById('cntLeft').textContent = deck.length;
  document.getElementById('cntSips').textContent = sessionSips;
}

function setFeedback(msg, cls) {
  const el = document.getElementById('feedback');
  el.textContent = msg;
  el.className = 'feedback ' + cls;
}

function updateHistoryPanel() {
  const grid = document.getElementById('historyGrid');
  if (seenCards.length === 0) {
    grid.innerHTML = '<div style="font-size:0.65rem;color:var(--text-muted);grid-column:1/-1">Aucune carte vue</div>';
    return;
  }
  grid.innerHTML = '';
  const recent = seenCards.slice(-20).reverse();
  for (const c of recent) {
    const d = document.createElement('div');
    d.className = 'history-card ' + (isRed(c)?'red-suit':'black-suit');
    d.textContent = `${c.value}${c.suit}`;
    grid.appendChild(d);
  }
}

function updatePlayersTable() {
  const tbody = document.getElementById('playersTableBody');
  if (players.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="color:var(--text-muted)">Aucun joueur</td></tr>';
    return;
  }
  const sorted = [...players].sort((a,b)=>a.sips-b.sips);
  tbody.innerHTML = '';
  for (const p of sorted) {
    const tr = document.createElement('tr');
    if (players[activePlayerIdx] && p.name === players[activePlayerIdx].name) tr.className = 'active-player';
    tr.innerHTML = `<td>${p.name}</td><td>${p.games}</td><td>${p.sips}</td>`;
    tbody.appendChild(tr);
  }
}

// ========== THEME TOGGLE ==========
let isLight = false;
function toggleTheme() {
  isLight = !isLight;
  document.body.classList.toggle('light', isLight);
  const knob = document.getElementById('themeKnob');
  knob.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
}

// ========== TIMER ==========
let timerEnabled  = false;
let timerDuration = 10;   // seconds
let timerRemaining = 0;
let timerInterval  = null;
const CIRCUMFERENCE = 2 * Math.PI * 20; // r=20 ‚Üí ‚âà 125.66

function toggleTimer() {
  timerEnabled = !timerEnabled;
  const pill = document.getElementById('timerPill');
  const info = document.getElementById('timerPenaltyInfo');
  pill.classList.toggle('on', timerEnabled);
  info.style.display = timerEnabled ? 'block' : 'none';
  if (!timerEnabled) stopTimer();
  resetTimerDisplay();
}

function updateTimerDuration(val) {
  timerDuration = parseInt(val);
  document.getElementById('timerDurLabel').textContent = val + 's';
  resetTimerDisplay();
}

function resetTimerDisplay() {
  stopTimer();
  const disp = document.getElementById('timerDisplay');
  const fill = document.getElementById('timerRingFill');
  if (!timerEnabled) {
    disp.textContent = '‚Äî';
    disp.className = 'timer-display ok';
    fill.style.strokeDashoffset = '0';
    fill.style.stroke = 'var(--green)';
    return;
  }
  disp.textContent = timerDuration;
  disp.className = 'timer-display ok';
  fill.style.strokeDashoffset = '0';
  fill.style.stroke = 'var(--green)';
}

function startTimer() {
  if (!timerEnabled) return;
  stopTimer();
  timerRemaining = timerDuration;
  renderTimer();
  timerInterval = setInterval(() => {
    timerRemaining--;
    renderTimer();
    if (timerRemaining <= 0) {
      stopTimer();
      onTimerExpired();
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

function renderTimer() {
  const disp = document.getElementById('timerDisplay');
  const fill = document.getElementById('timerRingFill');
  const pct  = timerRemaining / timerDuration; // 1 ‚Üí 0

  disp.textContent = timerRemaining;

  // Colour + class
  let colour, cls;
  if (pct > 0.5)      { colour = 'var(--green)';   cls = 'ok'; }
  else if (pct > 0.25){ colour = 'var(--gold-light)'; cls = 'warn'; }
  else                { colour = 'var(--red-light)'; cls = 'urgent'; }

  disp.className = 'timer-display ' + cls;
  fill.style.stroke = colour;
  // Shrink the arc: dashoffset grows from 0 ‚Üí CIRCUMFERENCE as time runs out
  fill.style.strokeDashoffset = CIRCUMFERENCE * (1 - pct);
}

function onTimerExpired() {
  if (activePlayerIdx < 0 || gameWon) return;
  // Apply 1 penalty sip for timeout
  const penaltySips = 1;
  sessionSips += penaltySips;
  if (activePlayerIdx >= 0) players[activePlayerIdx].sips += penaltySips;
  currentCol = 0;
  setFeedback(`‚è± Temps √©coul√© ! ‚Äî Bois ${penaltySips} gorg√©e !`, 'wrong');
  showToast('‚è± Temps √©coul√© ! +1 gorg√©e');
  renderColumns();
  updateProbabilities();
  updateCounters();
  updateAvatar();
  updatePlayersTable();
  // Restart timer for next round
  startTimer();
}

// ========== TOAST ==========
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2500);
}

// ========== INIT ==========
renderColumns();
syncPlayers();
resetTimerDisplay();
</script>
</body>
</html>